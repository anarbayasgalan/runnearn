<div class="container" style="padding-top: 2rem;">
    <!-- Header -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 class="text-gradient">Dashboard</h1>
            <button (click)="logout()" class="btn btn-primary"
                style="background-color: var(--color-bg-secondary); border: 1px solid var(--color-error); color: var(--color-error); box-shadow: none;">
                Logout
            </button>
        </div>
    </div>
    <div *ngIf="loading()" class="card" style="text-align: center; padding: 3rem;">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: var(--color-text-muted);">Loading your dashboard...</p>
    </div>

    <div *ngIf="error() && !loading()" class="card"
        style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-error);">
        <p style="color: var(--color-error); margin: 0;">{{ error() }}</p>
        <button (click)="loadDashboardData()" class="btn btn-primary" style="margin-top: 1rem;">
            Retry
        </button>
    </div>

    <div *ngIf="!loading() && !error()">
        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1.5rem;">Company Information</h2>

            <div style="display: grid; grid-template-columns: auto 1fr; gap: 2rem; align-items: start;">
                <div *ngIf="company()?.picture"
                    style="width: 120px; height: 120px; border-radius: var(--radius-sm); overflow: hidden; border: 2px solid var(--color-border);">
                    <img [src]="company().picture" alt="Company Logo"
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div *ngIf="!company()?.picture"
                    style="width: 120px; height: 120px; border-radius: var(--radius-sm); background: var(--color-bg-secondary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--color-border);">
                    <span style="font-size: 3rem; color: var(--color-text-muted);">üè¢</span>
                </div>

                <div>
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">{{ company()?.company || 'No Company Name' }}
                    </h3>
                    <p *ngIf="company()?.details" style="color: var(--color-text-muted); margin: 0; line-height: 1.6;">
                        {{ company().details }}
                    </p>
                    <p *ngIf="!company()?.details"
                        style="color: var(--color-text-muted); margin: 0; font-style: italic;">
                        No company description provided.
                    </p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 1.5rem;">Token Management</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <button (click)="openRedeemModal()" class="btn btn-primary"
                    style="padding: 1.5rem; height: auto; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.1rem; font-weight: 600;">Redeem / Check Code</span>
                    <span style="font-size: 0.9rem; opacity: 0.8;">Validate and redeem tokens</span>
                </button>

                <button (click)="openCreateModal()" class="btn btn-primary"
                    style="padding: 1.5rem; height: auto; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.1rem; font-weight: 600;">Create Code</span>
                    <span style="font-size: 0.9rem; opacity: 0.8;">Generate new tokens</span>
                </button>
            </div>
        </div>

        <!-- Token Lists -->
        <div class="card" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Token Lists</h2>

            <!-- Active Tokens -->
            <div style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: hsl(var(--color-primary));">Active Tokens ({{
                    getActiveTokens().length }})</h3>

                <div *ngIf="getActiveTokens().length === 0"
                    style="text-align: center; padding: 2rem; color: var(--color-text-muted);">
                    No active tokens yet. Create your first token above!
                </div>

                <div *ngIf="getActiveTokens().length > 0" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--color-border); text-align: left;">
                                <th style="padding: 0.75rem;">Token Code</th>
                                <th style="padding: 0.75rem;">Price</th>
                                <th style="padding: 0.75rem;">Challenge</th>
                                <th style="padding: 0.75rem;">Expiry</th>
                                <th style="padding: 0.75rem;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let token of getActiveTokens()"
                                style="border-bottom: 1px solid var(--color-border);">
                                <td style="padding: 0.75rem;">
                                    <code
                                        style="background: var(--color-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                                        {{ token.tkn }}
                                    </code>
                                </td>
                                <td style="padding: 0.75rem;">{{ token.price || 'N/A' }}</td>
                                <td style="padding: 0.75rem; max-width: 300px;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ token.challenge || 'N/A' }}
                                    </div>
                                </td>
                                <td style="padding: 0.75rem;">
                                    <span *ngIf="token.expireDate">
                                        {{ token.expireDate | date:'MM/dd/yyyy' }}
                                    </span>
                                    <span *ngIf="!token.expireDate">No expiry</span>
                                </td>
                                <td style="padding: 0.75rem;">
                                    <span *ngIf="isExpired(token)"
                                        style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                        Expired
                                    </span>
                                    <span *ngIf="!isExpired(token)"
                                        style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                        Active
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Redeemed Tokens -->
            <div>
                <h3 style="margin-bottom: 1rem; color: var(--color-text-muted);">Redeemed Tokens ({{
                    getRedeemedTokens().length }})</h3>

                <div *ngIf="getRedeemedTokens().length === 0"
                    style="text-align: center; padding: 2rem; color: var(--color-text-muted);">
                    No redeemed tokens yet.
                </div>

                <div *ngIf="getRedeemedTokens().length > 0" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--color-border); text-align: left;">
                                <th style="padding: 0.75rem;">Token Code</th>
                                <th style="padding: 0.75rem;">Price</th>
                                <th style="padding: 0.75rem;">Challenge</th>
                                <th style="padding: 0.75rem;">Redeemed</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let token of getRedeemedTokens()"
                                style="border-bottom: 1px solid var(--color-border); opacity: 0.7;">
                                <td style="padding: 0.75rem;">
                                    <code
                                        style="background: var(--color-bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem; text-decoration: line-through;">
                                        {{ token.tkn }}
                                    </code>
                                </td>
                                <td style="padding: 0.75rem;">{{ token.price || 'N/A' }}</td>
                                <td style="padding: 0.75rem; max-width: 300px;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        {{ token.challenge || 'N/A' }}
                                    </div>
                                </td>
                                <td style="padding: 0.75rem;">
                                    <span *ngIf="token.redeemedDate">
                                        {{ token.redeemedDate | date:'MM/dd/yyyy HH:mm:ss' }}
                                    </span>
                                    <span *ngIf="!token.redeemedDate">-</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="showRedeemModal()" class="modal-overlay" (click)="closeRedeemModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Redeem / Check Code</h2>
                <button (click)="closeRedeemModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-muted);">
                    √ó
                </button>
            </div>

            <div *ngIf="!redeemResult()">
                <div class="form-group">
                    <label for="redeemCode">Enter Token Code</label>
                    <input type="text" id="redeemCode" [(ngModel)]="redeemCode" placeholder="Enter code here..."
                        class="form-control">
                </div>

                <div class="form-group">
                    <label for="redeemPassword">Confirm Password *</label>
                    <input type="password" id="redeemPassword" [(ngModel)]="redeemPassword"
                        placeholder="Enter your password" class="form-control" required>
                    <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                        Verify your identity to redeem token
                    </small>
                </div>

                <button (click)="redeemToken()"
                    [disabled]="!redeemCode.trim() || !redeemPassword.trim() || tokenLoading()" class="btn btn-primary"
                    style="width: 100%;">
                    <span *ngIf="!tokenLoading()">Redeem Code</span>
                    <span *ngIf="tokenLoading()">Processing...</span>
                </button>
            </div>

            <div *ngIf="redeemResult()">
                <div *ngIf="redeemResult().responseCode === 0"
                    style="padding: 1.5rem; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: var(--radius-sm); text-align: center;">
                    <span style="font-size: 3rem;">‚úÖ</span>
                    <h3 style="color: #22c55e; margin: 1rem 0 0.5rem 0;">Success!</h3>
                    <p style="margin: 0; color: var(--color-text-muted);">{{ redeemResult().responseDesc }}</p>
                </div>

                <div *ngIf="redeemResult().responseCode !== 0"
                    style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-error); border-radius: var(--radius-sm); text-align: center;">
                    <span style="font-size: 3rem;">‚ùå</span>
                    <h3 style="color: var(--color-error); margin: 1rem 0 0.5rem 0;">Error</h3>
                    <p style="margin: 0; color: var(--color-text-muted);">{{ redeemResult().responseDesc }}</p>
                </div>

                <button (click)="closeRedeemModal()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Close
                </button>
            </div>
        </div>
    </div>
    <div *ngIf="showCreateModal()" class="modal-overlay" (click)="closeCreateModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Create New Token</h2>
                <button (click)="closeCreateModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-muted);">
                    √ó
                </button>
            </div>

            <div *ngIf="!createdToken()">
                <form [formGroup]="tokenForm" (ngSubmit)="createToken()">
                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="date" formControlName="expireDate" class="form-control" [min]="getCurrentDate()"
                            required>
                        <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                            When should these tokens expire?
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Price/Discount *</label>
                        <input type="text" formControlName="price" class="form-control" placeholder="e.g., 5% discount"
                            required>
                        <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                            What's the offer? (e.g., "5% discount" or "$10 off")
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Challenge/Goal *</label>
                        <textarea formControlName="challenge" class="form-control" rows="3"
                            placeholder="e.g., 10km in 4:00 pace" required></textarea>
                        <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                            What's the running challenge to complete?
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Number of Tokens *</label>
                        <input type="number" formControlName="quantity" class="form-control" min="1" max="100" required>
                        <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                            How many people can redeem this? (Max: 100)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" formControlName="userPass" class="form-control"
                            placeholder="Enter your password" required>
                        <small style="color: var(--color-text-muted); font-size: 0.85rem;">
                            Verify your identity to create tokens
                        </small>
                    </div>

                    <button type="submit" [disabled]="tokenForm.invalid || tokenLoading()" class="btn btn-primary"
                        style="width: 100%;">
                        <span *ngIf="!tokenLoading()">Create Tokens</span>
                        <span *ngIf="tokenLoading()">Creating...</span>
                    </button>
                </form>
            </div>

            <div *ngIf="createdToken()">
                <div *ngIf="createdToken().responseCode === 0"
                    style="padding: 1.5rem; background: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-sm); text-align: center;">
                    <span style="font-size: 3rem;">üéâ</span>
                    <h3 style="margin: 1rem 0 0.5rem 0;">Tokens Created!</h3>
                    <p style="margin: 0 0 1rem 0; color: var(--color-text-muted);">{{ createdToken().responseDesc }}</p>

                    <div *ngIf="createdToken().tokens && createdToken().tokens.length > 0"
                        style="max-height: 300px; overflow-y: auto; margin-top: 1rem;">
                        <div *ngFor="let token of createdToken().tokens; let i = index"
                            style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem; text-align: left;">
                            <p style="margin: 0 0 0.25rem 0; font-size: 0.85rem; color: var(--color-text-muted);">
                                Token {{ i + 1 }}:
                            </p>
                            <code
                                style="font-size: 1rem; font-weight: 600; color: var(--color-primary); word-break: break-all; display: block;">{{ token }}</code>
                        </div>
                    </div>
                </div>

                <div *ngIf="createdToken().responseCode !== 0"
                    style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-error); border-radius: var(--radius-sm); text-align: center;">
                    <span style="font-size: 3rem;">‚ùå</span>
                    <h3 style="color: var(--color-error); margin: 1rem 0 0.5rem 0;">Error</h3>
                    <p style="margin: 0; color: var(--color-text-muted);">{{ createdToken().responseDesc }}</p>
                </div>

                <button (click)="closeCreateModal()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-bg-secondary);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-content {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
</style>